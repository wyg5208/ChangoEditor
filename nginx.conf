worker_processes 4;  # 设置为CPU核心数(4核)

events {
    worker_connections 4096;  # 提高连接数以支持1000+并发用户
    multi_accept on;
}

http {
    # 基本设置
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    tcp_nodelay   on;
    keepalive_timeout 65;
    server_tokens off;  # 不显示Nginx版本

    # 真实IP检测配置 - 支持阿里云海外CDN环境
    # 设置可信代理IP范围（根据实际CDN提供商调整）
    
    # 阿里云CDN IP段（基于日志分析）
    set_real_ip_from 163.181.0.0/16;     # 阿里云海外CDN主要IP段
    set_real_ip_from 47.246.0.0/16;      # 阿里云CDN
    set_real_ip_from 118.31.0.0/16;      # 阿里云CDN
    set_real_ip_from 120.55.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.91.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.88.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.74.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.75.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.89.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.92.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.93.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.94.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.95.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.96.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.97.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.98.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.99.0.0/16;       # 阿里云CDN
    set_real_ip_from 47.100.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.101.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.102.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.103.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.104.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.105.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.106.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.107.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.108.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.109.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.110.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.111.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.112.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.113.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.114.0.0/16;      # 阿里云CDN
    set_real_ip_from 47.115.0.0/16;      # 阿里云CDN
    
    # 通用CDN IP段（保持兼容性）
    set_real_ip_from 10.0.0.0/8;         # 内网IP段
    set_real_ip_from 172.16.0.0/12;      # 内网IP段
    set_real_ip_from 192.168.0.0/16;     # 内网IP段
    
    # 设置真实IP的获取头部优先级 - 阿里云CDN优先
    real_ip_header X-Forwarded-For;      # 阿里云CDN标准头部
    real_ip_recursive on;                # 递归查找真实IP

    # 请求处理优化
    client_header_timeout 60s;
    client_body_timeout 60s;
    reset_timedout_connection on;

    # 日志格式定义
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for" '
                   '"$request_time" "$upstream_response_time" "$upstream_cache_status"';

    # 日志文件位置
    access_log d:/nginx/logs/access.log main buffer=16k;
    error_log  d:/nginx/logs/error.log warn;

    # 上传文件大小限制
    client_max_body_size 32M;
    client_body_buffer_size 16M;  # 适当增加上传缓冲区大小

    # 缓存配置
    proxy_cache_path d:/nginx/cache levels=1:2 keys_zone=madechango_cache:100m 
                     max_size=2g inactive=60m use_temp_path=off;
    
    # YouTube应用缓存
    proxy_cache_path d:/nginx/youtube_cache levels=1:2 keys_zone=youtube_cache:50m 
                     max_size=1g inactive=30m use_temp_path=off;

    # 启用gzip压缩
    gzip on;
    gzip_comp_level 5;  # 压缩等级 (1-9)
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_vary on;  # 告诉代理服务器内容已压缩
    gzip_types 
        text/plain text/css text/xml text/javascript
        application/javascript application/json application/xml
        application/xml+rss application/x-javascript
        image/svg+xml;

    # 上游服务器（后端应用）定义
    upstream madechango_backend {
        # 替换ip_hash为least_conn，根据连接数分配请求
        least_conn;
        
        # 增加重试次数和减少失败超时，更快速地检测到失败
        server 127.0.0.1:5001 max_fails=2 fail_timeout=10s weight=1;
        server 127.0.0.1:5002 max_fails=2 fail_timeout=10s weight=1;
        server 127.0.0.1:5003 max_fails=2 fail_timeout=10s weight=1;
        server 127.0.0.1:5004 max_fails=2 fail_timeout=10s weight=1;
        
        # 保持连接
        keepalive 32;
    }
    
    # YouTube应用后端定义
    upstream youtube_backend {
        server 127.0.0.1:5010 max_fails=2 fail_timeout=10s;
        keepalive 8;
    }
    
    # 论文助手应用后端定义
    upstream thesis_assistant_backend {
        # server 100.113.206.27:8000 max_fails=2 fail_timeout=10s;
        server 100.93.74.111:8000 max_fails=2 fail_timeout=10s;
        keepalive 8;
    }

    # 主服务器配置
    server {
        listen       80;
        server_name  madechango.com www.madechango.com;  # 替换为实际域名
        
        # 网站根目录，用于提供静态文件 - 更新为新的app/static结构
        root D:/python_projects/madechango/app/static;
        index index.html;

        # 访问日志
        access_log d:/nginx/logs/madechango.access.log main;
        error_log  d:/nginx/logs/madechango.error.log;

        # 设置默认字符集
        charset utf-8;

        # 静态文件处理 - 更新路径为app/static
        location /static/ {
            alias D:/python_projects/madechango/app/static/;  # 更新为新的静态文件路径
            expires 30d;
            add_header Cache-Control "public";
            access_log off;  # 关闭静态资源日志记录
            tcp_nodelay off;
            open_file_cache max=3000 inactive=120s;
            open_file_cache_valid 45s;
            open_file_cache_min_uses 2;
            open_file_cache_errors off;
        }

        # robots.txt和sitemap.xml直接访问 - 更新路径
        location = /robots.txt {
            alias D:/python_projects/madechango/app/static/robots.txt;
            access_log off;
            log_not_found off;
            expires 1d;
        }

        location = /sitemap.xml {
            alias D:/python_projects/madechango/app/static/sitemap.xml;
            access_log off;
            log_not_found off;
            expires 1d;
            add_header Content-Type "application/xml";
        }

        # 上传文件处理 - 更新路径
        location /uploads/ {
            alias D:/python_projects/madechango/app/static/uploads/;
            expires 30d;
            add_header Cache-Control "public";
            access_log off;
        }

        # 图标文件 - 更新路径
        location = /favicon.ico {
            alias D:/python_projects/madechango/app/static/img/favicon.ico;
            access_log off;
            log_not_found off;
            expires max;
        }

        # 文献核查API特殊处理 - 延长超时时间
        location ~ ^/thesis_assistant_proxy/api/v1/reference/ {
            rewrite ^/thesis_assistant_proxy/(.*) /$1 break;
            proxy_pass http://thesis_assistant_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 延长超时时间用于文献核查
            proxy_connect_timeout 120s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            
            # 禁用缓存
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            
            # 支持大文件上传
            client_max_body_size 50M;
            client_body_timeout 300s;
        }

        # 论文助手API专用代理 - 必须放在静态资源之前
        location ~ ^/thesis_assistant_proxy/api/ {
            rewrite ^/thesis_assistant_proxy/(.*) /$1 break;
            proxy_pass http://thesis_assistant_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # API请求不缓存
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 120s;
            
            # 支持大文件上传
            client_max_body_size 100M;
            client_body_timeout 300s;
        }

        # 论文助手静态资源代理 - 只处理static和favicon
        location ~ ^/thesis_assistant_proxy/(static|favicon\.ico) {
            rewrite ^/thesis_assistant_proxy/(.*) /$1 break;
            proxy_pass http://thesis_assistant_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 静态资源缓存
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # 论文助手页面路由代理 - 处理所有页面请求
        location ~ ^/thesis_assistant_proxy/(smart-search|ai-analysis|literature-review|writing-task|citation-verify|reference-check|magic-writing|smart-charts|ai-detection|document-management|ai)$ {
            rewrite ^/thesis_assistant_proxy/(.*) /$1 break;
            proxy_pass http://thesis_assistant_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 应用相同的链接重写规则
            sub_filter 'http://madechango.com/' 'https://madechango.com/thesis_assistant_proxy/';
            sub_filter 'https://madechango.com/' 'https://madechango.com/thesis_assistant_proxy/';
            sub_filter 'href="/' 'href="/thesis_assistant_proxy/';
            sub_filter 'src="/' 'src="/thesis_assistant_proxy/';
            sub_filter '/api/v1/' '/thesis_assistant_proxy/api/v1/';
            sub_filter '/static/' '/thesis_assistant_proxy/static/';
            
            # 特定页面链接修复
            sub_filter '/smart-search' '/thesis_assistant_proxy/smart-search';
            sub_filter '/ai-analysis' '/thesis_assistant_proxy/ai-analysis';
            sub_filter '/literature-review' '/thesis_assistant_proxy/literature-review';
            sub_filter '/writing-task' '/thesis_assistant_proxy/writing-task';
            sub_filter '/citation-verify' '/thesis_assistant_proxy/citation-verify';
            sub_filter '/reference-check' '/thesis_assistant_proxy/reference-check';
            sub_filter '/magic-writing' '/thesis_assistant_proxy/magic-writing';
            sub_filter '/smart-charts' '/thesis_assistant_proxy/smart-charts';
            sub_filter '/ai-detection' '/thesis_assistant_proxy/ai-detection';
            sub_filter '/document-management' '/thesis_assistant_proxy/document-management';
            
            sub_filter_once off;
            sub_filter_types text/css text/xml text/javascript application/javascript application/json;
            
            # 禁用缓存
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # 论文助手应用代理
        location /thesis_assistant_proxy/ {
            rewrite ^/thesis_assistant_proxy/(.*) /$1 break;
            proxy_pass http://thesis_assistant_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 修复Mixed Content问题 - 将HTTP资源链接转换为HTTPS
            sub_filter 'http://madechango.com/' 'https://madechango.com/thesis_assistant_proxy/';
            sub_filter 'https://madechango.com/' 'https://madechango.com/thesis_assistant_proxy/';
            sub_filter 'src="http://' 'src="https://';
            sub_filter 'href="http://' 'href="https://';
            
            # 修复内部链接问题 - 将相对路径和绝对路径重写为代理路径
            sub_filter 'href="/' 'href="/thesis_assistant_proxy/';
            sub_filter 'src="/' 'src="/thesis_assistant_proxy/';
            sub_filter 'action="/' 'action="/thesis_assistant_proxy/';
            sub_filter 'url("/' 'url("/thesis_assistant_proxy/';
            sub_filter "href='/" "href='/thesis_assistant_proxy/";
            sub_filter "src='/" "src='/thesis_assistant_proxy/";
            
            # 修复JavaScript中的URL引用
            sub_filter '/api/v1/' '/thesis_assistant_proxy/api/v1/';
            sub_filter '/static/' '/thesis_assistant_proxy/static/';
            sub_filter '"/' '"/thesis_assistant_proxy/';
            sub_filter "'/" "'/thesis_assistant_proxy/";
            
            # 修复特定的论文助手页面链接
            sub_filter '/smart-search' '/thesis_assistant_proxy/smart-search';
            sub_filter '/ai-analysis' '/thesis_assistant_proxy/ai-analysis';
            sub_filter '/literature-review' '/thesis_assistant_proxy/literature-review';
            sub_filter '/writing-task' '/thesis_assistant_proxy/writing-task';
            sub_filter '/citation-verify' '/thesis_assistant_proxy/citation-verify';
            sub_filter '/reference-check' '/thesis_assistant_proxy/reference-check';
            sub_filter '/magic-writing' '/thesis_assistant_proxy/magic-writing';
            sub_filter '/smart-charts' '/thesis_assistant_proxy/smart-charts';
            sub_filter '/ai-detection' '/thesis_assistant_proxy/ai-detection';
            sub_filter '/document-management' '/thesis_assistant_proxy/document-management';
            
            sub_filter_once off;
            sub_filter_types text/css text/xml text/javascript application/javascript application/json;
            
            # 禁用缓存，确保实时数据
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 120s;
            
            # 支持大文件上传
            client_max_body_size 100M;
            client_body_timeout 300s;
            
            # 缓冲区设置
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 8 32k;
            proxy_busy_buffers_size 64k;
        }

        # 对文件上传路径特别处理 - 关闭请求缓冲
        location ~ ^/(auth/verify|rental/create|used-items/create|study-guide/create) {
            proxy_request_buffering off;  # 关闭请求缓冲，直接传输数据
            proxy_pass http://madechango_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            client_max_body_size 32M;  # 上传接口特别设置大文件限制
            client_body_timeout 300s;  # 上传超时时间延长
        }

        # 备份API专用代理配置
        location /api/backup/ {
            proxy_pass http://madechango_backend;
            
            # 完整的IP头部配置 - 重要：确保真实IP传递
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 备份API特殊配置
            # 允许大文件下载
            client_max_body_size 100M;
            client_body_timeout 300s;
            
            # 延长超时时间（备份可能需要较长时间）
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            
            # 禁用缓存（确保实时数据）
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            
            # 支持Range请求（断点续传）
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 8 32k;
            proxy_busy_buffers_size 64k;
            
            # 安全设置
            add_header X-Frame-Options "DENY";
            add_header X-Content-Type-Options "nosniff";
        }

        # 所有其他请求代理到后端应用
        location / {
            proxy_pass http://madechango_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 缓存配置
            proxy_cache madechango_cache;
            proxy_cache_valid 200 302 10m;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_lock on;
            proxy_cache_background_update on;
            add_header X-Cache-Status $upstream_cache_status;
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 120s;  # 增加读取超时，避免长请求断开
            
            # 缓冲区设置
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 8 32k;
            proxy_busy_buffers_size 64k;
        }

        # 错误页面 - 更新路径
        error_page  404              /html/404.html;
        error_page  500 502 503 504  /html/50x.html;
        
        location = /html/404.html {
            root   D:/python_projects/madechango/app/static;
        }
        
        location = /html/50x.html {
            root   D:/python_projects/madechango/app/static;
        }
    }
    
    # YouTube应用服务器配置
    server {
        listen       80;
        server_name  youtube.wyg.life;
        
        # 网站根目录
        root D:/python_projects/data_research_tool/youtube_app/static;
        index index.html;

        # 访问日志
        access_log d:/nginx/logs/wyg.access.log main;
        error_log  d:/nginx/logs/wyg.error.log;

        # 设置默认字符集
        charset utf-8;

        # 静态文件处理
        location /static/ {
            alias D:/python_projects/data_research_tool/youtube_app/static/;
            expires 30d;
            add_header Cache-Control "public";
            access_log off;
            tcp_nodelay off;
            open_file_cache max=3000 inactive=120s;
            open_file_cache_valid 45s;
            open_file_cache_min_uses 2;
            open_file_cache_errors off;
        }

        # 图标文件
        location = /favicon.ico {
            alias D:/python_projects/data_research_tool/youtube_app/static/images/favicon.ico;
            access_log off;
            log_not_found off;
            expires max;
        }

        # 所有其他请求代理到后端应用
        location / {
            proxy_pass http://youtube_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 缓存配置
            proxy_cache youtube_cache;
            proxy_cache_valid 200 302 10m;
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_lock on;
            proxy_cache_background_update on;
            add_header X-Cache-Status $upstream_cache_status;
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 120s;
            
            # 缓冲区设置
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 8 32k;
            proxy_busy_buffers_size 64k;
        }


   
        # 修改分析结果路径处理，确保POST请求能正确传递
        location /analyze/results {
            # 改为传递所有HTTP方法，特别是POST
            limit_except GET POST { deny all; }
            
            proxy_pass http://youtube_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            
            # 彻底禁用缓存
            proxy_no_cache 1;
            proxy_cache_bypass 1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            
            # 禁用所有缓冲
            proxy_buffering off;
            proxy_request_buffering off;
            
            # 扩展超时时间
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            
            # 允许大型POST数据
            client_max_body_size 15M;
            client_body_timeout 300s;
        }
        
        # 添加对分析状态的特殊处理
        location /analyze/status/ {
            proxy_pass http://youtube_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            proxy_buffering off;
            proxy_cache_bypass 1;
            proxy_no_cache 1;
        }
        
        # 添加对分析开始的特殊处理
        location /analyze/start {
            limit_except POST { deny all; }
            proxy_pass http://youtube_backend;
            
            # 完整的IP头部配置 - 阿里云CDN优化
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            # 阿里云CDN专用头部
            proxy_set_header Ali-Swift-Stat-Host $http_ali_swift_stat_host;
            proxy_set_header X-Via $http_x_via;
            proxy_set_header X-Forwarded-Port $server_port;
            # 通用CDN头部（保持兼容性）
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
            proxy_set_header True-Client-IP $http_true_client_ip;
            proxy_set_header X-Originating-IP $http_x_originating_ip;
            proxy_set_header X-Client-IP $http_x_client_ip;
            proxy_set_header X-Cluster-Client-IP $http_x_cluster_client_ip;
            proxy_set_header Forwarded-For $http_forwarded_for;
            proxy_set_header Forwarded $http_forwarded;
            proxy_buffering off;
            proxy_request_buffering off;
            client_max_body_size 10M;
        }
        
        # 全局错误页处理
        error_page 404 /html/404.html;
        error_page 500 502 503 504 /html/50x.html;
        
        # 错误页面本地化处理
        location = /html/404.html {
            internal;
            root D:/python_projects/data_research_tool/youtube_app/static;
        }
        
        location = /html/50x.html {
            internal;
            root D:/python_projects/data_research_tool/youtube_app/static;
        }
    }
}

